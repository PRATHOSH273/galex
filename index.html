<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Galex Premium - Music Player</title>
 <link rel="icon" href="logo.png">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
    --galex-blue: #1d51b9;
    --galex-light-blue: #1eafd7;
    --galex-dark: #121212;
    --galex-card: #181818;
    --galex-gray: #b3b3b3;
    --galex-light-gray: #282828;
    --galex-white: #ffffff;
    --transition-speed: 0.3s;
    --border-radius: 8px;
    --player-height: 90px;
    --sidebar-width: 280px;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Circular', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
}

body {
    background: var(--galex-dark);
    color: var(--galex-white);
    height: 100vh;
    overflow: hidden;
}

/* Background Effects */
.background-gradient {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(180deg, #121212 0%, #1a1a1a 100%);
    z-index: -2;
}

.background-pattern {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: 
        radial-gradient(circle at 20% 80%, rgba(29, 81, 185, 0.08) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(30, 175, 215, 0.05) 0%, transparent 50%);
    z-index: -1;
}

/* Layout */
.app-container {
    display: flex;
    height: 100vh;
    gap: 1px;
}

/* Sidebar */
.sidebar {
    width: var(--sidebar-width);
    background: var(--galex-dark);
    display: flex;
    flex-direction: column;
    padding: 24px 12px;
    border-right: 1px solid rgba(255, 255, 255, 0.05);
}

.logo {
    padding: 0 12px 24px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.logo-icon {
    font-size: 32px;
    color: var(--galex-blue);
    font-weight: 900;
}

.logo-text {
    font-size: 28px;
    font-weight: 900;
    letter-spacing: -1.5px;
    background: linear-gradient(45deg, var(--galex-blue), var(--galex-light-blue));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.nav-section {
    margin-bottom: 32px;
}

.nav-menu {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.nav-item {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 12px;
    border-radius: 6px;
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    color: var(--galex-gray);
    font-size: 14px;
    font-weight: 600;
}

.nav-item:hover {
    background: rgba(255, 255, 255, 0.05);
    color: var(--galex-white);
}

.nav-item.active {
    background: rgba(255, 255, 255, 0.1);
    color: var(--galex-white);
}

.nav-icon {
    font-size: 20px;
    width: 24px;
    text-align: center;
}

.main-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.top-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 32px;
    background: rgba(0, 0, 0, 0.3);
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.nav-controls {
    display: flex;
    gap: 16px;
}

.nav-btn {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.5);
    border: none;
    color: var(--galex-white);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-speed) ease;
}

.nav-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    transform: scale(1.1);
}

.search-container {
    position: relative;
    width: 300px;
}

.search-input {
    width: 100%;
    padding: 10px 20px 10px 44px;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    border-radius: 50px;
    color: var(--galex-white);
    font-size: 14px;
    outline: none;
}

.search-icon {
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--galex-gray);
    font-size: 14px;
}

.user-profile {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 6px 12px 6px 6px;
    background: rgba(0, 0, 0, 0.5);
    border-radius: 50px;
    cursor: pointer;
}

.user-avatar {
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, var(--galex-blue), var(--galex-light-blue));
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 14px;
    color: var(--galex-white);
}

/* Now Playing Section */
.now-playing {
    flex: 1;
    padding: 40px;
    overflow-y: auto;
}

.now-playing-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 40px;
}

.now-playing-header h2 {
    font-size: 32px;
    font-weight: 900;
}

.album-info {
    display: flex;
    align-items: flex-start;
    gap: 40px;
    margin-bottom: 40px;
}

.album-art-container {
    position: relative;
    width: 320px;
    height: 320px;
    border-radius: 50%;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    border: 4px solid var(--galex-blue);
}

.album-art {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
}

.album-details {
    flex: 1;
}

.album-title {
    font-size: 72px;
    font-weight: 900;
    line-height: 1;
    margin-bottom: 20px;
}

.album-stats {
    display: flex;
    gap: 32px;
    margin-bottom: 32px;
}

.stat-item {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.stat-label {
    font-size: 12px;
    color: var(--galex-gray);
}

.stat-value {
    font-size: 24px;
    font-weight: 700;
    color: var(--galex-white);
}

/* Playback Controls */
.playback-controls {
    padding: 20px 32px;
    background: linear-gradient(to bottom, transparent, rgba(18, 18, 18, 0.9) 20%);
    border-top: 1px solid rgba(255, 255, 255, 0.05);
}

.progress-container {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 20px;
}

.time-stamp {
    font-size: 14px;
    color: var(--galex-gray);
    min-width: 40px;
}

.progress-bar {
    flex: 1;
    height: 4px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 2px;
    position: relative;
    cursor: pointer;
    overflow: hidden;
}

.progress-fill {
    position: absolute;
    height: 100%;
    background: var(--galex-blue);
    border-radius: 2px;
    width: 0%;
}

.controls-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 20px;
}

.controls-center {
    display: flex;
    align-items: center;
    gap: 24px;
}

.control-btn {
    background: none;
    border: none;
    color: var(--galex-gray);
    cursor: pointer;
    font-size: 18px;
    transition: all var(--transition-speed) ease;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
}

.control-btn:hover {
    color: var(--galex-white);
    transform: scale(1.1);
}

.control-btn.play-pause {
    width: 48px;
    height: 48px;
    background: var(--galex-blue);
    color: var(--galex-white);
    border-radius: 50%;
    font-size: 20px;
}

.control-btn.play-pause:hover {
    transform: scale(1.05);
    background: var(--galex-light-blue);
}

/* Playlist */
.playlist-section {
    padding: 0 32px 32px;
}

.playlist-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
}

.playlist-header h3 {
    font-size: 24px;
    font-weight: 900;
}

.sort-options {
    display: flex;
    gap: 8px;
}

.sort-btn {
    padding: 6px 12px;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    border-radius: 4px;
    color: var(--galex-gray);
    font-size: 12px;
    cursor: pointer;
    transition: all var(--transition-speed) ease;
}

.sort-btn:hover {
    background: rgba(255, 255, 255, 0.15);
    color: var(--galex-white);
}

.sort-btn.active {
    background: var(--galex-blue);
    color: var(--galex-white);
    font-weight: 600;
}

.playlist-table {
    width: 100%;
    border-collapse: collapse;
}

.playlist-table th {
    text-align: left;
    padding: 12px 16px;
    font-size: 12px;
    color: var(--galex-gray);
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    font-weight: 400;
}

.playlist-table td {
    padding: 12px 16px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.02);
    transition: background var(--transition-speed) ease;
}

.playlist-table tr {
    cursor: pointer;
}

.playlist-table tr:hover {
    background: rgba(255, 255, 255, 0.05);
}

.playlist-table tr.active {
    background: rgba(29, 81, 185, 0.1);
}

.track-number {
    width: 40px;
    text-align: center;
    font-size: 14px;
    color: var(--galex-gray);
}

.track-title {
    display: flex;
    align-items: center;
    gap: 12px;
}

.track-image {
    width: 40px;
    height: 40px;
    border-radius: 4px;
    object-fit: cover;
}

.track-info {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.track-name {
    font-size: 16px;
    font-weight: 500;
}

.track-artist {
    font-size: 14px;
    color: var(--galex-gray);
}

.track-album {
    font-size: 14px;
    color: var(--galex-gray);
}

.track-year {
    width: 80px;
    font-size: 14px;
    color: var(--galex-gray);
}

.track-duration {
    width: 60px;
    font-size: 14px;
    color: var(--galex-gray);
}

.track-actions {
    width: 40px;
    text-align: center;
}

.action-btn {
    background: none;
    border: none;
    color: var(--galex-gray);
    cursor: pointer;
    font-size: 16px;
    transition: all var(--transition-speed) ease;
}

.action-btn:hover {
    color: var(--galex-blue);
}

/* Animation for album art rotation */
@keyframes albumRotate {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.album-art.playing {
    animation: albumRotate 20s linear infinite;
}

/* Toast Notification */
.toast {
    position: fixed;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: var(--galex-blue);
    color: var(--galex-white);
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 14px;
    z-index: 1000;
    opacity: 0;
    transition: all 0.3s ease;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
}

/* Spotify Badge */
.spotify-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: #1DB954;
    color: white;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 700;
    margin-left: 8px;
    vertical-align: middle;
}

/* Responsive */
@media (max-width: 1200px) {
    .album-title {
        font-size: 56px;
    }
    
    .album-art-container {
        width: 280px;
        height: 280px;
    }
}

@media (max-width: 992px) {
    .album-info {
        flex-direction: column;
    }
    
    .album-art-container {
        align-self: center;
    }
}

@media (max-width: 768px) {
    .top-bar {
        padding: 16px;
    }
    
    .search-container {
        width: 200px;
    }
    
    .now-playing {
        padding: 24px;
    }
    
    .album-title {
        font-size: 40px;
    }
}

/* Wave Animation */
.wave-animation {
    display: flex;
    align-items: center;
    gap: 4px;
    height: 20px;
}

.wave-bar {
    width: 3px;
    height: 100%;
    background: var(--galex-blue);
    border-radius: 3px;
    animation: wave 1.2s ease-in-out infinite;
}

.wave-bar:nth-child(2) { animation-delay: -1.1s; }
.wave-bar:nth-child(3) { animation-delay: -1.0s; }
.wave-bar:nth-child(4) { animation-delay: -0.9s; }
.wave-bar:nth-child(5) { animation-delay: -0.8s; }

@keyframes wave {
    0%, 40%, 100% { transform: scaleY(0.4); }
    20% { transform: scaleY(1); }
}
</style>
</head>
<body>
<div class="background-gradient"></div>
<div class="background-pattern"></div>

<div class="app-container">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <div class="logo-icon">G</div>
            <div class="logo-text">Galex</div>
        </div>
        
        <div class="nav-section">
            <div class="nav-menu">
                <div class="nav-item active">
                    <div class="nav-icon"><i class="fas fa-home"></i></div>
                    <span>Home</span>
                </div>
                <div class="nav-item">
                    <div class="nav-icon"><i class="fas fa-search"></i></div>
                    <span>Search</span>
                </div>
                <div class="nav-item">
                    <div class="nav-icon"><i class="fas fa-book"></i></div>
                    <span>Your Library</span>
                </div>
                <div class="nav-item" id="spotifyConnectBtn">
                    <div class="nav-icon"><i class="fab fa-spotify"></i></div>
                    <span>Connect Spotify</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="nav-controls">
                <button class="nav-btn" onclick="prevSong()">
                    <i class="fas fa-step-backward"></i>
                </button>
                <button class="nav-btn" onclick="nextSong()">
                    <i class="fas fa-step-forward"></i>
                </button>
            </div>
            
            <div class="search-container">
                <div class="search-icon">
                    <i class="fas fa-search"></i>
                </div>
                <input type="text" class="search-input" placeholder="Search songs, artists, or albums" 
                       oninput="filterSongs(this.value)" id="searchInput">
            </div>
            
            <div class="user-profile" id="userProfile">
                <div class="user-avatar" id="userAvatar">U</div>
                <span class="username" id="username">User</span>
            </div>
        </div>
        
        <div class="now-playing">
            <div class="now-playing-header">
                <h2>Now Playing</h2>
                <div class="wave-animation" id="waveAnimation" style="display: none;">
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                </div>
            </div>
            
            <div class="album-info">
                <div class="album-art-container">
                    <img id="songImg" class="album-art" src="https://th.bing.com/th/id/OIP.3pJ7dpx_ajr_3Qm0WdOG2QHaFj?w=233&h=180" alt="Album Art">
                </div>
                
                <div class="album-details">
                    <h1 class="album-title" id="songName">Song Name</h1>
                    
                    <div class="album-stats">
                        <div class="stat-item">
                            <div class="stat-label">Artist</div>
                            <div class="stat-value" id="artistName">Artist</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Music Director</div>
                            <div class="stat-value" id="musicDirector">Director</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Year</div>
                            <div class="stat-value" id="songYear">2024</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Playlist Section -->
            <div class="playlist-section">
                <div class="playlist-header">
                    <h3>Playlist</h3>
                    <div class="sort-options">
                        <button class="sort-btn" onclick="sortSongs('name')">Title</button>
                        <button class="sort-btn" onclick="sortSongs('year')">Year</button>
                        <button class="sort-btn active" onclick="sortSongs('artist')">Artist</button>
                        <button class="sort-btn" onclick="sortSongs('music')">Director</button>
                    </div>
                </div>
                
                <table class="playlist-table" id="playlistTable">
                    <thead>
                        <tr>
                            <th style="width: 50px;">#</th>
                            <th>Title</th>
                            <th>Album</th>
                            <th style="width: 100px;">Year</th>
                            <th style="width: 80px;"><i class="far fa-clock"></i></th>
                            <th style="width: 50px;"></th>
                        </tr>
                    </thead>
                    <tbody id="songList">
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="playback-controls">
            <div class="progress-container">
                <span class="time-stamp" id="currentTime">0:00</span>
                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <span class="time-stamp" id="duration">0:00</span>
            </div>
            
            <div class="controls-row">
                <div class="controls-center">
                    <button class="control-btn" onclick="prevSong()">
                        <i class="fas fa-step-backward"></i>
                    </button>
                    <button class="control-btn play-pause" onclick="playPause()" id="playBtn">
                        <i class="fas fa-play"></i>
                    </button>
                    <button class="control-btn" onclick="nextSong()">
                        <i class="fas fa-step-forward"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div class="toast" id="toast"></div>

<script>
// Enhanced Playlist Data
const playlist = [
    {
        src: "Aagaya Suriyanai - Harish Raghavendra, Harini.mp3",
        img: "https://imgs.search.brave.com/Q5zayQ_Cu-59A30OLKV506-l6o8-HsCbHYVzO7UN9wA/rs:fit:500:0:1:0/g:ce/aHR0cHM6Ly9tLm1l/ZGlhLWFtYXpvbi5j/b20vaW1hZ2VzL00v/TVY1Qk9XVXlORE15/WlRndE5HUTNOeTAw/TkRRd0xUaG1ZVGt0/TWpsa1kySmxORGcz/WTJabFhrRXlYa0Zx/Y0djQC5qcGc",
        name: "Aagaya Suriyanai",
        album: "Album One",
        year: 2002,
        music: "Harris Jayaraj",
        artist: "Harish Raghavendra",
        duration: "3:45"
    },
    {
        src: "Aaha Kalyanam - From  Petta  - Anthony Daasan.mp3",
        img: "https://imgs.search.brave.com/DBWnzWSsMXVy4ffTIUeaob65Eo0sRkAERsQs6rO3Jgg/rs:fit:860:0:0:0/g:ce/aHR0cHM6Ly9jLnNh/YXZuY2RuLmNvbS9h/cnRpc3RzL0FuaXJ1/ZGhfUmF2aWNoYW5k/ZXJfMDAyXzIwMjQw/MTAzMDY0NTU4XzUw/MHg1MDAuanBn",
        name: "Aaha Kalyanam",
        album: "Petta (Original Motion Picture Soundtrack)",
        year: 2019,
        music: "Anirudh",
        artist: "Anthony Daasan",
        duration: "4:20"
    },
    {
        src: "Aai Mailapuru - Srikanth Deva, Manikka Vinayagam, Sabesh, Ganga, Suchitra.mp3",
        img: "https://th.bing.com/th/id/OIP._O5RxCytnC2wEs91vkjlpgHaEK?w=266&h=180",
        name: "Aai Mailapuru",
        album: "Classical Collection",
        year: 2004,
        music: "Srikanth Deva",
        artist: "Manikka Vinayagam",
        duration: "5:10"
    },
    {
        src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3",
        img: "https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80",
        name: "Melody Waves",
        album: "Modern Vibes",
        year: 2020,
        music: "Yuvan Shankar",
        artist: "Sid Sriram",
        duration: "4:05"
    },
    {
        src: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3",
        img: "https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80",
        name: "Rhythm Divine",
        album: "Eternal Beats",
        year: 2018,
        music: "A.R. Rahman",
        artist: "Shreya Ghoshal",
        duration: "3:55"
    },
    {
        src: "Aala Asatthum - S. P. Balasubrahmanyam, Vani Jairam.mp3",
        img: "https://imgs.search.brave.com/HLoz5a15uQERXDF1cuqlE50fu_VcG-IHHslmaQV1PnA/rs:fit:500:0:1:0/g:ce/aHR0cHM6Ly9tZWRp/YS5pbnNpZGVyLmlu/L2ltYWdlL3VwbG9h/ZC9jX2Nyb3AsZ19j/dXN0b20vdjE3MzIx/Njc0ODgvY2t4cWlv/bngzN3NiOHF2d2tp/enkuanBn",
        name: "Aala Asatthum",
        album: "Kanni Rasi",
        year: 1985,
        music: "Ilaiyaraaja",
        artist: "S. P. Balasubrahmanyam",
        duration: "4:30"
    },
    {
        src: "Aaluma Doluma - Anirudh Ravichander, Badshah.mp3",
        img: "https://images.unsplash.com/photo-1470225620780-dba8ba36b745?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80",
        name: "Aaluma Doluma",
        album: "vethalam",
        year: 2015,
        music: "Anirudh Ravichander",
        artist: "Anirudh Ravichander",
        duration: "4:30"
    },
    {
        src: "Aariya Udhadugal - Hariharan, Swarnalatha.mp3",
        img: "https://images.unsplash.com/photo-1470225620780-dba8ba36b745?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80",
        name: "Aariya Udhadugal",
        album: "Chellamae",
        year: 2004,
        music: "Harris Jayaraj",
        artist: "Hariharan, Swarnalatha",
        duration: "4:30"
    }
];

// Spotify Configuration
const SPOTIFY_CONFIG = {
    clientId: 'YOUR_SPOTIFY_CLIENT_ID_HERE', // Replace with your actual Client ID
    redirectUri: window.location.origin + '/callback', // Will work with current page
    scopes: [
        'user-read-private',
        'user-read-email',
        'user-read-playback-state',
        'user-modify-playback-state',
        'user-read-currently-playing',
        'streaming',
        'playlist-read-private',
        'playlist-read-collaborative'
    ].join(' ')
};

// Player State
let audio = new Audio();
let currentIndex = 0;
let filteredSongs = [...playlist];
let isPlaying = false;
let spotifyToken = null;
let spotifyPlayer = null;
let isSpotifyConnected = false;
let spotifyDeviceId = null;

// DOM Elements
const elements = {
    songImg: document.getElementById('songImg'),
    songName: document.getElementById('songName'),
    artistName: document.getElementById('artistName'),
    musicDirector: document.getElementById('musicDirector'),
    songYear: document.getElementById('songYear'),
    currentTime: document.getElementById('currentTime'),
    duration: document.getElementById('duration'),
    progressBar: document.getElementById('progressBar'),
    progressFill: document.getElementById('progressFill'),
    playBtn: document.getElementById('playBtn'),
    songList: document.getElementById('songList'),
    waveAnimation: document.getElementById('waveAnimation'),
    toast: document.getElementById('toast'),
    searchInput: document.getElementById('searchInput'),
    userAvatar: document.getElementById('userAvatar'),
    username: document.getElementById('username'),
    spotifyConnectBtn: document.getElementById('spotifyConnectBtn')
};

// ======================
// SPOTIFY FUNCTIONS
// ======================

// Initialize Spotify SDK
function initSpotify() {
    const script = document.createElement('script');
    script.src = 'https://sdk.scdn.co/spotify-player.js';
    script.async = true;
    document.head.appendChild(script);
    
    window.onSpotifyWebPlaybackSDKReady = () => {
        console.log('Spotify Web Playback SDK ready');
        // Check for stored token
        const storedToken = localStorage.getItem('spotify_token');
        if (storedToken) {
            spotifyToken = storedToken;
            isSpotifyConnected = true;
            setupSpotifyPlayer(storedToken);
            updateConnectionStatus();
            showToast('Reconnected to Spotify', 'info');
        }
    };
}

// Connect to Spotify
function connectSpotify() {
    const authUrl = `https://accounts.spotify.com/authorize?response_type=token&client_id=${SPOTIFY_CONFIG.clientId}&scope=${encodeURIComponent(SPOTIFY_CONFIG.scopes)}&redirect_uri=${encodeURIComponent(SPOTIFY_CONFIG.redirectUri)}&show_dialog=true`;
    window.location.href = authUrl;
}

// Handle Spotify Callback
function handleSpotifyCallback() {
    const hash = window.location.hash.substring(1);
    const params = new URLSearchParams(hash);
    
    const token = params.get('access_token');
    if (token) {
        spotifyToken = token;
        isSpotifyConnected = true;
        localStorage.setItem('spotify_token', token);
        setupSpotifyPlayer(token);
        showToast('Successfully connected to Spotify!', 'info');
        updateConnectionStatus();
        
        // Remove token from URL
        window.history.replaceState({}, document.title, window.location.pathname);
    }
}

// Setup Spotify Web Player
function setupSpotifyPlayer(token) {
    spotifyPlayer = new Spotify.Player({
        name: 'Galex Premium Player',
        getOAuthToken: cb => { cb(token); },
        volume: 0.5
    });

    // Ready
    spotifyPlayer.addListener('ready', ({ device_id }) => {
        console.log('Ready with Device ID', device_id);
        spotifyDeviceId = device_id;
        showToast('Spotify player ready', 'info');
    });

    // Not Ready
    spotifyPlayer.addListener('not_ready', ({ device_id }) => {
        console.log('Device ID has gone offline', device_id);
        spotifyDeviceId = null;
    });

    spotifyPlayer.addListener('initialization_error', ({ message }) => {
        console.error('Failed to initialize', message);
        showToast('Spotify player failed to initialize', 'error');
    });

    spotifyPlayer.addListener('authentication_error', ({ message }) => {
        console.error('Failed to authenticate', message);
        showToast('Spotify authentication failed', 'error');
        disconnectSpotify();
    });

    spotifyPlayer.addListener('account_error', ({ message }) => {
        console.error('Failed to validate Spotify account', message);
        showToast('Spotify account error', 'error');
    });

    // Player state
    spotifyPlayer.addListener('player_state_changed', state => {
        if (!state) return;
        
        const { track_window: { current_track }, paused, position, duration } = state;
        
        // Update UI with current track
        if (current_track) {
            updateNowPlayingUI(current_track);
            
            // Update progress bar
            if (duration > 0) {
                const progress = (position / duration) * 100;
                elements.progressFill.style.width = `${progress}%`;
                elements.currentTime.textContent = formatTime(position / 1000);
                elements.duration.textContent = formatTime(duration / 1000);
            }
        }
        
        // Update playback state
        isPlaying = !paused;
        updatePlayButton();
    });

    // Connect to the player
    spotifyPlayer.connect().then(success => {
        if (success) {
            console.log('Spotify player connected successfully');
        }
    });
}

// Update UI with Spotify track info
function updateNowPlayingUI(track) {
    if (track) {
        elements.songImg.src = track.album.images[0]?.url || 'https://via.placeholder.com/300';
        elements.songName.textContent = track.name;
        elements.artistName.textContent = track.artists.map(a => a.name).join(', ');
        elements.musicDirector.textContent = 'Spotify';
        elements.songYear.textContent = new Date(track.album.release_date).getFullYear() || 'Unknown';
        
        // Start album rotation if playing
        if (isPlaying) {
            elements.songImg.classList.add('playing');
            elements.waveAnimation.style.display = 'flex';
        } else {
            elements.songImg.classList.remove('playing');
            elements.waveAnimation.style.display = 'none';
        }
    }
}

// Play Spotify Track
function playSpotifyTrack(spotifyUri) {
    if (!spotifyToken || !spotifyDeviceId) {
        showToast('Please connect to Spotify first', 'error');
        connectSpotify();
        return;
    }

    fetch(`https://api.spotify.com/v1/me/player/play?device_id=${spotifyDeviceId}`, {
        method: 'PUT',
        headers: {
            'Authorization': `Bearer ${spotifyToken}`,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            uris: [spotifyUri]
        })
    }).then(response => {
        if (response.status === 404) {
            showToast('Device not found. Try reconnecting to Spotify.', 'error');
        } else if (response.ok) {
            showToast('Playing from Spotify', 'info');
            isPlaying = true;
            updatePlayButton();
        } else if (response.status === 403) {
            showToast('Spotify Premium required for playback', 'error');
        }
    }).catch(error => {
        console.error('Playback error:', error);
        showToast('Failed to play track', 'error');
    });
}

// Search Spotify
async function searchSpotify(query) {
    if (!spotifyToken) {
        showToast('Please connect to Spotify first', 'error');
        return [];
    }

    try {
        const response = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=10`, {
            headers: {
                'Authorization': `Bearer ${spotifyToken}`
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            return data.tracks.items;
        } else if (response.status === 401) {
            // Token expired
            disconnectSpotify();
            showToast('Spotify session expired. Please reconnect.', 'error');
        }
        return [];
    } catch (error) {
        console.error('Search error:', error);
        return [];
    }
}

// Disconnect Spotify
function disconnectSpotify() {
    if (spotifyPlayer) {
        spotifyPlayer.disconnect();
    }
    spotifyToken = null;
    spotifyPlayer = null;
    isSpotifyConnected = false;
    spotifyDeviceId = null;
    localStorage.removeItem('spotify_token');
    updateConnectionStatus();
    showToast('Disconnected from Spotify', 'info');
}

// Update connection status UI
function updateConnectionStatus() {
    if (isSpotifyConnected) {
        elements.userAvatar.innerHTML = '<i class="fab fa-spotify"></i>';
        elements.userAvatar.style.background = '#1DB954'; // Spotify green
        elements.username.textContent = 'Spotify';
        elements.spotifyConnectBtn.querySelector('span').textContent = 'Connected to Spotify';
    } else {
        elements.userAvatar.textContent = 'U';
        elements.userAvatar.style.background = 'linear-gradient(135deg, var(--galex-blue), var(--galex-light-blue))';
        elements.username.textContent = 'User';
        elements.spotifyConnectBtn.querySelector('span').textContent = 'Connect Spotify';
    }
}

// ======================
// LOCAL PLAYER FUNCTIONS
// ======================

// Initialize Player
function initPlayer() {
    loadSong(currentIndex);
    updatePlaylist();
    setupEventListeners();
    showToast('Galex Player Ready', 'info');
    initSpotify();
    handleSpotifyCallback();
}

// Load Song
function loadSong(index) {
    if (index < 0 || index >= filteredSongs.length) return;
    
    currentIndex = index;
    const song = filteredSongs[currentIndex];
    
    // Check if it's a Spotify track
    if (song.isSpotify) {
        // Play Spotify track
        playSpotifyTrack(song.src);
        
        // Update UI
        elements.songImg.src = song.img;
        elements.songName.textContent = song.name;
        elements.artistName.textContent = song.artist;
        elements.musicDirector.textContent = song.music;
        elements.songYear.textContent = song.year;
        
        showToast(`Now Playing from Spotify: ${song.name}`, 'info');
    } else {
        // Play local track
        audio.src = song.src;
        
        // Update UI elements
        elements.songImg.src = song.img;
        elements.songName.textContent = song.name;
        elements.artistName.textContent = song.artist;
        elements.musicDirector.textContent = song.music;
        elements.songYear.textContent = song.year;
        
        // Reset progress
        elements.progressFill.style.width = '0%';
        elements.currentTime.textContent = '0:00';
        
        // Show notification
        showToast(`Now Playing: ${song.name}`, 'info');
    }
    
    // Update playlist highlighting
    updatePlaylist();
}

// Play/Pause
function playPause() {
    if (isSpotifyConnected && spotifyPlayer) {
        spotifyPlayer.togglePlay().then(() => {
            isPlaying = !isPlaying;
            updatePlayButton();
        }).catch(error => {
            console.error('Spotify playback error:', error);
            // Fall back to local player
            playPauseLocal();
        });
    } else {
        playPauseLocal();
    }
}

// Local player play/pause
function playPauseLocal() {
    if (audio.src) {
        if (isPlaying) {
            audio.pause();
            elements.playBtn.innerHTML = '<i class="fas fa-play"></i>';
            elements.songImg.classList.remove('playing');
            elements.waveAnimation.style.display = 'none';
        } else {
            audio.play().then(() => {
                elements.playBtn.innerHTML = '<i class="fas fa-pause"></i>';
                elements.songImg.classList.add('playing');
                elements.waveAnimation.style.display = 'flex';
            }).catch(e => {
                console.log('Playback failed:', e);
                showToast('Playback failed. Please check audio file.', 'error');
            });
        }
        isPlaying = !isPlaying;
    } else {
        loadSong(currentIndex);
        playPause();
    }
}

// Update play button
function updatePlayButton() {
    if (isPlaying) {
        elements.playBtn.innerHTML = '<i class="fas fa-pause"></i>';
        elements.waveAnimation.style.display = 'flex';
    } else {
        elements.playBtn.innerHTML = '<i class="fas fa-play"></i>';
        elements.waveAnimation.style.display = 'none';
    }
}

// Navigation
function nextSong() {
    if (filteredSongs.length === 0) return;
    
    currentIndex = (currentIndex + 1) % filteredSongs.length;
    loadSong(currentIndex);
    
    if (isPlaying) {
        if (filteredSongs[currentIndex].isSpotify) {
            // Spotify will handle playback
        } else {
            audio.play().then(() => {
                elements.playBtn.innerHTML = '<i class="fas fa-pause"></i>';
                elements.songImg.classList.add('playing');
                elements.waveAnimation.style.display = 'flex';
            });
        }
    }
}

function prevSong() {
    if (filteredSongs.length === 0) return;
    
    if (!filteredSongs[currentIndex].isSpotify && audio.currentTime > 3) {
        audio.currentTime = 0;
        showToast('Restarted current song', 'info');
    } else {
        currentIndex = (currentIndex - 1 + filteredSongs.length) % filteredSongs.length;
        loadSong(currentIndex);
        
        if (isPlaying) {
            if (filteredSongs[currentIndex].isSpotify) {
                // Spotify will handle playback
            } else {
                audio.play().then(() => {
                    elements.playBtn.innerHTML = '<i class="fas fa-pause"></i>';
                    elements.songImg.classList.add('playing');
                    elements.waveAnimation.style.display = 'flex';
                });
            }
        }
    }
}

// Progress Bar
function setupProgressBar() {
    audio.ontimeupdate = () => {
        if (audio.duration && !isNaN(audio.duration)) {
            const progress = (audio.currentTime / audio.duration) * 100;
            elements.progressFill.style.width = `${progress}%`;
            elements.currentTime.textContent = formatTime(audio.currentTime);
            elements.duration.textContent = formatTime(audio.duration);
        }
    };
    
    elements.progressBar.addEventListener('click', (e) => {
        if (isSpotifyConnected && spotifyPlayer) {
            // Spotify progress bar doesn't support click-to-seek via Web Playback SDK
            showToast('Seek not available for Spotify Web Player', 'info');
            return;
        }
        
        const rect = e.currentTarget.getBoundingClientRect();
        const percent = (e.clientX - rect.left) / rect.width;
        if (audio.duration) {
            audio.currentTime = percent * audio.duration;
        }
    });
}

// Format Time
function formatTime(seconds) {
    if (isNaN(seconds)) return "0:00";
    const min = Math.floor(seconds / 60);
    const sec = Math.floor(seconds % 60);
    return `${min}:${sec < 10 ? '0' : ''}${sec}`;
}

// Update Playlist
function updatePlaylist() {
    elements.songList.innerHTML = '';
    
    filteredSongs.forEach((song, index) => {
        const row = document.createElement('tr');
        row.className = index === currentIndex ? 'active' : '';
        row.onclick = () => {
            currentIndex = index;
            loadSong(currentIndex);
            if (!isPlaying) {
                playPause();
            } else if (!song.isSpotify) {
                audio.play();
            }
        };
        
        const spotifyBadge = song.isSpotify ? '<span class="spotify-badge"><i class="fab fa-spotify"></i>Spotify</span>' : '';
        
        row.innerHTML = `
            <td class="track-number">
                ${index === currentIndex && isPlaying ? '<div class="wave-animation"><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div></div>' : index + 1}
            </td>
            <td class="track-title">
                <img src="${song.img}" alt="${song.name}" class="track-image">
                <div class="track-info">
                    <div class="track-name">${song.name} ${spotifyBadge}</div>
                    <div class="track-artist">${song.artist}</div>
                </div>
            </td>
            <td class="track-album">${song.album}</td>
            <td class="track-year">${song.year}</td>
            <td class="track-duration">${song.duration}</td>
            <td class="track-actions">
                <button class="action-btn" onclick="event.stopPropagation(); toggleFavorite(${index})">
                    <i class="far fa-heart"></i>
                </button>
            </td>
        `;
        
        elements.songList.appendChild(row);
    });
}

// Search and Filter
async function filterSongs(query) {
    if (query.trim() === '') {
        filteredSongs = [...playlist];
        currentIndex = 0;
        if (filteredSongs.length > 0) {
            loadSong(currentIndex);
        }
        updatePlaylist();
        return;
    }
    
    const searchTerm = query.toLowerCase();
    filteredSongs = playlist.filter(song => 
        song.name.toLowerCase().includes(searchTerm) ||
        song.artist.toLowerCase().includes(searchTerm) ||
        song.music.toLowerCase().includes(searchTerm) ||
        song.album.toLowerCase().includes(searchTerm)
    );
    
    // Also search Spotify if connected
    if (isSpotifyConnected && query.length > 2) {
        const spotifyResults = await searchSpotify(query);
        spotifyResults.forEach(track => {
            filteredSongs.push({
                src: track.uri, // Spotify URI
                img: track.album.images[0]?.url || '',
                name: track.name,
                album: track.album.name,
                year: new Date(track.album.release_date).getFullYear(),
                music: 'Spotify',
                artist: track.artists.map(a => a.name).join(', '),
                duration: `${Math.floor(track.duration_ms / 60000)}:${((track.duration_ms % 60000) / 1000).toFixed(0).padStart(2, '0')}`,
                isSpotify: true
            });
        });
    }
    
    currentIndex = 0;
    if (filteredSongs.length > 0) {
        loadSong(currentIndex);
    } else {
        showToast('No songs found', 'info');
    }
    updatePlaylist();
}

// Sort
function sortSongs(type) {
    document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    filteredSongs.sort((a, b) => {
        if (type === 'name') return a.name.localeCompare(b.name);
        if (type === 'year') return a.year - b.year;
        if (type === 'artist') return a.artist.localeCompare(b.artist);
        if (type === 'music') return a.music.localeCompare(b.music);
        return 0;
    });
    
    updatePlaylist();
}

// Favorites
function toggleFavorite(index) {
    event.stopPropagation();
    const btn = event.target.closest('button');
    const icon = btn.querySelector('i');
    
    if (icon.classList.contains('far')) {
        icon.classList.remove('far');
        icon.classList.add('fas');
        icon.style.color = '#1d51b9';
        showToast('Added to favorites', 'info');
    } else {
        icon.classList.remove('fas');
        icon.classList.add('far');
        icon.style.color = '';
        showToast('Removed from favorites', 'info');
    }
}

// Toast Notifications
function showToast(message, type = 'info') {
    elements.toast.textContent = message;
    elements.toast.style.background = type === 'error' ? '#e22134' : 
                                      '#1d51b9'; // Always use Galex blue for info/success
    
    elements.toast.classList.add('show');
    
    setTimeout(() => {
        elements.toast.classList.remove('show');
    }, 3000);
}

// Event Listeners
function setupEventListeners() {
    // Audio events
    audio.onended = () => {
        if (!isSpotifyConnected) {
            nextSong();
        }
    };
    
    audio.onerror = () => {
        showToast('Error loading audio file', 'error');
        isPlaying = false;
        updatePlayButton();
        elements.songImg.classList.remove('playing');
        elements.waveAnimation.style.display = 'none';
    };
    
    // Spotify connect button
    elements.spotifyConnectBtn.onclick = () => {
        if (!isSpotifyConnected) {
            connectSpotify();
        } else {
            if (confirm('Disconnect from Spotify?')) {
                disconnectSpotify();
            }
        }
    };
    
    // User profile click
    document.getElementById('userProfile').onclick = () => {
        if (isSpotifyConnected) {
            showToast('Connected to Spotify', 'info');
        } else {
            showToast('Galex Music Player', 'info');
        }
    };
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        switch(e.code) {
            case 'Space':
                e.preventDefault();
                playPause();
                break;
            case 'ArrowRight':
                if (e.ctrlKey) nextSong();
                break;
            case 'ArrowLeft':
                if (e.ctrlKey) prevSong();
                break;
            case 'KeyK':
                if (e.ctrlKey) playPause();
                break;
        }
    });
    
    // Setup progress bar
    setupProgressBar();
}

// Initialize when page loads
window.addEventListener('DOMContentLoaded', initPlayer);

// Export functions to global scope for onclick handlers
window.playPause = playPause;
window.prevSong = prevSong;
window.nextSong = nextSong;
window.filterSongs = filterSongs;
window.sortSongs = sortSongs;
window.connectSpotify = connectSpotify;
</script>
</body>
</html>
